---
- name: "Test installing Guest Additions from Ubuntu's official repository"
  hosts: all
  become: true
  tasks:
    - name: "1. Action: Add Universe and Multiverse repositories"
      ansible.builtin.apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} main restricted universe multiverse"
        state: present
        filename: 'ubuntu-with-community'
        update_cache: true

    - name: "2. Action: Install build dependencies"
      ansible.builtin.apt:
        name:
          - build-essential
          - dkms
          - "linux-headers-{{ ansible_kernel }}"
          - perl
          - libelf-dev
        state: present
        update_cache: true

    - name: "3. Action: Install Guest Additions from Ubuntu repository"
      ansible.builtin.apt:
        name:
          - virtualbox-guest-utils
        state: present
        update_cache: true
      notify:
        - Reboot the machine

    - name: "4. Meta: Force all notified handlers to run now"
      ansible.builtin.meta: flush_handlers

    - name: "[5a] Verify: Get list of loaded kernel modules"
      ansible.builtin.command: lsmod
      register: lsmod_result
      changed_when: false

    - name: "[5b] Verify: Assert that 'vboxguest' is in the list of loaded modules"
      ansible.builtin.assert:
        that:
          - "'vboxguest' in lsmod_result.stdout"
        fail_msg: "Verification failed: vboxguest kernel module is not loaded."
        success_msg: "Verification successful: vboxguest kernel module is loaded."

  handlers:
    - name: "Reboot the machine"
      listen: "Reboot the machine"
      ansible.builtin.reboot:
        msg: "Rebooting machine to finalize Guest Additions installation."
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: whoami
